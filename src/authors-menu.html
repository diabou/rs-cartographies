<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/web-animations-js/web-animations-next.min.html"/>
<link rel="import" href="query-manager.html"/>

<dom-module id="authors-menu">
  <template>
    <style>
      .author {
        cursor: pointer;
      }

      paper-dropdown-menu.ok {
        --paper-input-container-label: {
          color: #6a6a6a;
        };

        --paper-dropdown-menu-icon: {
          color: #6a6a6a;
        }
      }

      paper-dropdown-menu.error {
        --paper-input-container-label: {
          color: #e83b3b;
        };

        --paper-dropdown-menu-icon: {
          color: #e83b3b;
        };
      }
    </style>

    <query-manager
        id="query"
        params='{"fl":"authFullName_s"}'
        on-response=_makeAuthorsList
        on-error=_handleError>
    </query-manager>

    <paper-dropdown-menu label=[[_inputLabel]] class$=[[_class]]>
      <paper-listbox id="listBox" slot="dropdown-content" selected-item={{_selectedItem}}>
        <template is="dom-repeat" items=[[_sortedNames]]>
          <paper-item class="author">[[item]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>

  </template>

  <script>
      /**
       * @customElement
       * @polymer
       */
      class AuthorsMenu extends Polymer.Element {
          static get is() {
              return 'authors-menu';
          }

          static get properties() {
              return {
                  /**
                   * List of author names (as Strings).
                   */
                  _sortedNames: {
                      type: Array,
                      value: () => []
                  },

                  /**
                   * HTML element containing the name of the currently selected author.
                   */
                  _selectedItem: {
                      type: Object,
                      notify: true,
                      observer: '_setSelected',
                      value: null
                  },

                  /**
                   * Name of the currently selected author.
                   */
                  selected: {
                      type: String,
                      notify: true,
                      reflectOnAttribute: true,
                      observer: '_backToNone',
                      value: null
                  },

                  /**
                   * The label displayed in the dropdown menu input.
                   */
                  _inputLabel: {
                      type: String,
                      value: 'Chose an author'
                  },

                  /**
                   * Class of the dropdown menu element, changes if an error is caught.
                   */
                  _class: {
                      type: String,
                      value: 'ok'
                  }
              };
          }

          ready() {
              super.ready();
              this.$.query.fetchAsJSON();
          }

          _setSelected(item) {
              if (item) {
                  this.set('selected', item.innerHTML);
              }
          }

          _makeAuthorsList(e) {
              this._toOk();
              this.set(
                  '_sortedNames',
                  Array.from(new Set(Array.prototype.concat.apply([], e.detail.body.map(doc => doc.authFullName_s))))
              );
          }

          _handleError() {
              this._toError();
              setTimeout(() => this.$.query.fetchAsJSON(), 5000);
          }

          _backToNone(newVal) {
              if (newVal === '') {
                  this.$.listBox.select(null);
              }
          }

          _toOk() {
              this.set('_class', 'ok');
              this.set('_inputLabel', 'Chose an author');
          }

          _toError() {
              this.set('_class', 'error');
              this.set('_inputLabel', 'failed to fetch names');
          }
      }

      window.customElements.define(AuthorsMenu.is, AuthorsMenu);
  </script>
</dom-module>