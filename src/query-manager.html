<dom-module id="query-manager">
  <script>
      /**
       * @customElement
       * @polymer
       */
      /*
        Urls :
          https://api.archives-ouvertes.fr/search/MINES-NANTES?q=*&fl=authFullName_s,title_s\\&wt=xml
          https://api.archives-ouvertes.fr/search/MINES-NANTES/?verb=ListRecords&metadataPrefix=oai_dc&facet=true&facet.field=authIdHasPrimaryStructure_fs&rows=9999&wt=xml
      */

      class QueryManager extends Polymer.Element {
          static get is() {
              return 'query-manager';
          }

          static get properties() {
              return {
                  /**
                   * base URL of the query
                   */
                  baseURL: {
                      type: String,
                      value: 'https://api.archives-ouvertes.fr/search/'
                  },

                  /**
                   * The institution to look data for
                   */
                  institution: {
                      type: String,
                      value: 'MINES-NANTES'
                  },

                  /**
                   * the 'q' parameter of the query
                   */
                  query: {
                      type: String,
                      value: '*'
                  },

                  /**
                   * other optional parameters
                   */
                  params: {
                      type: String,
                      value: null
                  }
              };
          }

          get _requestURL() {
              let res = this.baseURL + this.institution + '?q=' + this.query;

              if (this.params) {
                  const params = JSON.parse(this.params);
                  Object.keys(params)
                      .forEach(key => res = res.concat('&').concat(key).concat('=').concat(params[key]));
              }

              return res;
          }

          fetchAsJSON() {
              const handleError = res => {
                  if (!res.ok) {
                      throw Error(res.statusText);
                  }
                  return res.json();
              };

              fetch(this._requestURL)
                  .then(handleError)
                  .then(json => this.dispatchEvent(new CustomEvent('response', {detail: {body: json.response.docs}})))
                  .catch(e => this.dispatchEvent(new CustomEvent('error', {detail: {message: e.message}})));
          }
      }

      window.customElements.define(QueryManager.is, QueryManager);
  </script>
</dom-module>