<dom-module id="rs-carto-chart">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
        padding: 2px;
      }

      #query {
        @apply(--layout-flex-none);
      }

      #chartContainer {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }

      #pages {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }

      paper-spinner {
        top: 50%;
        left: 50%;
      }

      #chart {
        @apply(--layout-flex);
        font-family: "sans-serif";
        font-size: 10px;
        text-anchor: "middle";
      }

      #titleBar {
        @apply(--layout-flex);
        max-height: 20px;
        font-family: 'Roboto', sans-serif;
        color: #9e9e9e;
        font-size: 15px;
      }

      .error {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        @apply(--layout-around-justified);
        text-align: center;
        font-family: 'Roboto', sans-serif;
      }
    </style>

    <query-manager id="query" query=[[authorName]] on-response=_loadVisu></query-manager>

    <div id="chartContainer">
      <iron-pages id="pages">
        <paper-spinner active></paper-spinner>
        <svg id="chart"></svg>
        <div class="error"><div>[[_errorMessage]]</div></div>
      </iron-pages>
    </div>
    <app-toolbar id="titleBar"><div id="title" main-title></div></app-toolbar>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class RsCartoChart extends Polymer.Element {
        static get is() {
            return 'rs-carto-chart';
        }

        static get properties() {
            return {
                /**
                 * Currently selected author whose cartography has to be displayed
                 */
                authorName: {
                    type: String,
                    observer: '_fetchData',
                    value: null
                },

                /**
                 * List of the journals in which this author has published
                 */
                _data: {
                    type: Array,
                    value: () => []
                },

                /**
                 * Message to be displayed instead of the chart in case of an error.
                 */
                _errorMessage: {
                    type: String,
                    value: ''
                }
            };
        }

        static fillInTemplate(template, queryParams, chartTitle) {
            template.content.getElementById('query').setAttribute('params', queryParams);
            template.content.getElementById('title').innerText = chartTitle;
        }

        _fetchData(newVal) {
            if (newVal) {
                this.$.pages.select(0);
                this.$.query.fetchAsJSON();
            }
        }

        _loadVisu(e) {
            try {
                this.set('_data', this._formatData(e.detail.body));
                this._generateChart();
                this.$.pages.select(1);
            } catch (e) {
                this.set('_errorMessage', 'ERROR : '.concat(e.message || e));
                this.$.pages.select(2);
            }
        }

        get _dimensions() {
            const pages = d3.select(this.$.pages)._groups[0][0];
            return [pages.clientHeight, pages.clientWidth];
        }

        _generateChart() {
            throw new Error('RsCartoChart._generateChart is an abstract method and should be overwritten');
        }

        _formatData() {
            throw new Error('RsCartoChart._formatData is an abstract method and should be overwritten');
        }
    }

    window.customElements.define(RsCartoChart.is, RsCartoChart);
  </script>
</dom-module>