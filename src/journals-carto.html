<dom-module id="journals-carto">
  <script>

      (function() {
          /**
           * @customElement
           * @polymer
           */

          let memorizedTemplate;

          class JournalsCarto extends RsCartoChart {
              static get is() {
                  return 'journals-carto';
              }

              static get template() {
                  if (!memorizedTemplate) {
                      memorizedTemplate = RsCartoChart.template.cloneNode(true);
                      this.fillInTemplate(memorizedTemplate, '{"fl":"journalTitle_s,title_s,conferenceTitle_s,haliId_s"}', 'Where he published');
                  }
                  return memorizedTemplate;
              }

              _formatData(body) {
                  const rep = [];

                  let conferenceTitle,
                      journalTitle,
                      publication,
                      title,
                      alreadySaved;

                  body.forEach(doc => {
                      conferenceTitle = doc.conferenceTitle_s;
                      journalTitle = doc.journalTitle_s;

                      new Promise(resolve => {
                          if (conferenceTitle) {
                              title = 'conferences';
                              alreadySaved = rep.find(obj => obj.type === 'conferences');
                          } else if (journalTitle) {
                              title = journalTitle;
                              alreadySaved = rep
                                  .filter(obj => obj.type === 'journal')
                                  .find(journal => journal.title === journalTitle);
                          }
                          resolve(alreadySaved);
                      });

                      publication = {halId: doc.halId_s, title: doc.title_s[0]};

                      if (alreadySaved) {
                          alreadySaved.publications.push(publication);
                      } else {
                          rep.push({
                              title: title,
                              type: conferenceTitle ? 'conferences' : 'journal',
                              publications: [publication]
                          });
                      }
                  });

                  return rep;
              }

              _generateChart() {
                  const svg = d3.select(this.$.chart);
                  svg.html('');

                  const [height, width] = this._dimensions;

                  const color = d3.scaleOrdinal(d3.schemeCategory20c);

                  const bubble = d3.pack()
                      .size([width, height])
                      .padding(1.5);

                  const data = this._data.map(d => {
                      d.value = +d.publications.length;
                      return d;
                  });

                  const root = d3.hierarchy({children: data})
                      .sum(d => d.value)
                      .each(d => d.title = d.data.title || 'other ');

                  const bubbles = svg.selectAll('.node')
                      .data(bubble(root).leaves())
                      .enter().append('g')
                      .attr('class', 'node')
                      .attr('transform', d => 'translate(' + d.x + ',' + d.y + ')');

                  bubbles.append('circle')
                      .attr('r', d => d.r)
                      .style('fill', d => color(d.title));

                  bubbles.append('clipPath')
                      .attr('id', d => 'clip-' + d.title)
                      .append('use')
                      .attr('xlink:href', d => '#' + d.title);

                  bubbles.append('text')
                      .attr('clip-path', d => 'url(#clip-' + d.title + ')')
                      .attr('text-anchor', 'middle')
                      .selectAll('tspan')
                      .data(d => JournalsCarto._shortenTitle(d.title))
                      .enter().append('tspan')
                      .attr('x', 0)
                      .attr('y', (d, i, nodes) => 13 + (i - nodes.length / 2 - 0.5) * 10)
                      .text(d => d);

                  bubbles.append('title')
                      .text(d => d.title + ':\n\n- ' + d.data.publications.map(pub => pub.title).join('\n- '));
              }

              static _shortenTitle(title) {
                  if (title === 'conferences' || title === 'other') {
                      return [title];
                  }

                  let res = title.replace(/\./g, ' ').split(' ');
                  if (res.length > 4) {
                      res = res.slice(0, 4);
                      res[3] += '...';
                  }
                  return res;
              }
          }

          window.customElements.define(JournalsCarto.is, JournalsCarto);
      })();
  </script>
</dom-module>