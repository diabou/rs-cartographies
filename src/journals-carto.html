<dom-module id="journals-carto">
  <template>
    <style>
      :host {
        @apply(--layout-horizontal);
        padding: 2px;
      }

      #query {
        @apply(--layout-flex-none);
      }

      #chart {
        @apply(--layout-flex-2);
        font-family: "sans-serif";
        font-size: 10px;
        text-anchor: "middle";
      }
    </style>

    <query-manager
        id="query"
        query=[[authorName]]
        params='{"fl":"journalTitle_s,halId_s"}'
        on-response=_loadVisu>
    </query-manager>

    <svg id="chart"></svg>

  </template>

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script>
      /**
       * @customElement
       * @polymer
       */
      class JournalsCarto extends Polymer.Element {
          static get is() {
              return 'journals-carto';
          }

          static get properties() {
              return {
                  /**
                   * Currently selected author whose cartography has to be displayed
                   */
                  authorName: {
                      type: String,
                      observer: '_fetchJournals',
                      value: null
                  },

                  /**
                   * List of the journals in which this author has published
                   */
                  _journals: {
                      type: Array,
                      value: () => []
                  }
              };
          }

          _fetchJournals(newVal) {
              if (newVal) {
                  this.$.query.fetchAsJSON();
              }
          }

          _loadVisu(e) {
              this.set('_journals', JournalsCarto._loadJournals(e.detail.body));

              let svg = d3.select(this.$.chart);
              const height = +svg._groups[0][0].clientHeight;
              const width = +svg._groups[0][0].clientWidth;

              const color = d3.scaleOrdinal(d3.schemeCategory20c);

              const bubble = d3.pack()
                  .size([width, height])
                  .padding(1.5);

              const data = this._journals.map(d => { d.value = +d.publications.length; return d; });

              const root = d3.hierarchy({children: data})
                  .sum(d => d.value)
                  .each(d => d.title = d.data.title);

              console.log(root);

              const bubbles = svg.selectAll(".node")
                  .data(bubble(root).leaves())
                  .enter().append("g")
                  .attr("class", "node")
                  .attr("transform", 'translate(0, 0)');

              bubbles.append('circle')
                  .attr('r', d => d.r)
                  .attr('cx', d => d.x)
                  .attr('cy', d => d.y)
                  .style('fill', d => color(d.title));

              bubbles.append("clipPath")
                  .attr("id", function(d) { return "clip-" + d.title; })
                  .append("use")
                  .attr("xlink:href", function(d) { return "#" + d.title; });

              bubbles.append('text')
                  .attr('x', d => d.x)
                  .attr('y', d => d.y + 5)
                  .attr('text-anchor', 'middle')
                  .text(d => typeof d.title === 'undefined' ? 'no\ntitle\nfound' : d.title)
                  .style({
                      'fill':'white',
                      'font-family':'Helvetica Neue, Helvetica, Arial, san-serif',
                      'font-size': '10px'
                  });
          }

          static _loadJournals(body) {
              const rep = [];
              let doc,
                  title,
                  halId,
                  alreadySaved;

              for (let i = 0; i < body.length; i++) {
                  doc = body[i];
                  title = doc.journalTitle_s;
                  halId = doc.halId_s;

                  if (alreadySaved = rep.find(journal => journal.title === title)) {
                      alreadySaved.publications.push(halId);
                  } else {
                      rep.push({title: title, publications: [halId]});
                  }
              }

              return rep;
          }
      }

      window.customElements.define(JournalsCarto.is, JournalsCarto);
  </script>
</dom-module>