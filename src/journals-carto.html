<dom-module id="journals-carto">
  <template>
    <style>
      :host {
        @apply(--layout-horizontal);
        padding: 2px;
      }

      #query {
        @apply(--layout-flex-none);
      }

      #chart {
        @apply(--layout-flex-2);
        font-family: "sans-serif";
        font-size: 10px;
        text-anchor: "middle";
      }
    </style>

    <query-manager
        id="query"
        query=[[authorName]]
        params='{"fl":"journalTitle_s,halId_s"}'
        on-response=_loadVisu>
    </query-manager>

    <svg id="chart"></svg>

  </template>

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script>
      /**
       * @customElement
       * @polymer
       */
      class JournalsCarto extends Polymer.Element {
          static get is() {
              return 'journals-carto';
          }

          static get properties() {
              return {
                  /**
                   * Currently selected author whose cartography has to be displayed
                   */
                  authorName: {
                      type: String,
                      observer: '_fetchJournals',
                      value: null
                  },

                  /**
                   * List of the journals in which this author has published
                   */
                  _journals: {
                      type: Array,
                      value: () => []
                  }
              };
          }

          _fetchJournals(newVal) {
              if (newVal) {
                  this.$.query.fetchAsJSON();
              }
          }

          _loadVisu(e) {
              this.set('_journals', JournalsCarto._loadJournals(e.detail.body));

              const svg = d3.select(this.$.chart);
              svg.html('');
              const height = +svg._groups[0][0].clientHeight;
              const width = +svg._groups[0][0].clientWidth;

              const color = d3.scaleOrdinal(d3.schemeCategory20c);

              const bubble = d3.pack()
                  .size([width, height])
                  .padding(1.5);

              const data = this._journals.map(d => { d.value = +d.publications.length; return d; });

              const root = d3.hierarchy({children: data})
                  .sum(d => d.value)
                  .each(d => d.title = d.data.title || 'No Title Found');

              const bubbles = svg.selectAll('.node')
                  .data(bubble(root).leaves())
                  .enter().append('g')
                  .attr('class', 'node')
                  .attr('transform', d => 'translate(' + d.x + ',' + d.y + ')');

              bubbles.append('circle')
                  .attr('r', d => d.r)
                  .style('fill', d => color(d.title));

              bubbles.append('clipPath')
                  .attr('id', d => 'clip-' + d.title)
                  .append('use')
                  .attr('xlink:href', d => '#' + d.title);

              bubbles.append('text')
                  .attr('clip-path', d => 'url(#clip-' + d.title + ')')
                  .attr('text-anchor', 'middle')
                  .selectAll('tspan')
                  .data(d => JournalsCarto._shortenTitle(d.title))
                  .enter().append('tspan')
                  .attr('x', 0)
                  .attr('y', (d, i, nodes) => 13 + (i - nodes.length / 2 - 0.5) * 10)
                  .text(d => d);

              bubbles.append('title')
                  .text(d =>
                      d.title + ':\n  -' + d.data.publications
                          .map(pub => '<a href="google.fr">' + pub + '</a>')
                          .join('\n  -')
                  );
          }

          static _loadJournals(body) {
              const rep = [];
              let doc,
                  title,
                  halId,
                  alreadySaved;

              for (let i = 0; i < body.length; i++) {
                  doc = body[i];
                  title = doc.journalTitle_s;
                  halId = doc.halId_s;

                  if (alreadySaved = rep.find(journal => journal.title === title)) {
                      alreadySaved.publications.push(halId);
                  } else {
                      rep.push({title: title, publications: [halId]});
                  }
              }

              return rep;
          }

          static _shortenTitle(title) {
              let split = title.split(' ');
              if (split.length > 3) {
                  split = split.slice(0, 3);
                  split[2] += '...'
              }
              return split;
          }
      }

      window.customElements.define(JournalsCarto.is, JournalsCarto);
  </script>
</dom-module>