<dom-module id="journals-carto">
  <template>
    <style>
      :host {
        @apply(--layout-flex);
        padding: 2px;
      }
    </style>

    <query-manager
        id="query"
        query=[[authorName]]
        params='{"fl":"journalTitle_s,halId_s"}'
        on-response=_loadVisu>
    </query-manager>

    <paper-material elevation="1">
      <div>
        <template is="dom-repeat" items="[[_journals]]">
          <div>[[_stringify(item)]]</div>
        </template>
      </div>
    </paper-material>

  </template>

  <script>
      /**
       * @customElement
       * @polymer
       */
      class JournalsCarto extends Polymer.Element {
          static get is() {
              return 'journals-carto';
          }

          static get properties() {
              return {
                  /**
                   * Currently selected author whose cartography has to be displayed
                   */
                  authorName: {
                      type: String,
                      observer: '_fetchJournals',
                      value: null
                  },

                  /**
                   * List of the journals in which this author has published
                   */
                  _journals: {
                      type: Array,
                      value: () => []
                  }
              };
          }

          _fetchJournals(newVal) {
              if (newVal) {
                  this.$.query.fetchAsJSON();
              }
          }

          _loadVisu(e) {
              this.set('_journals', JournalsCarto._loadJournals(e.detail.body));
          }

          static _loadJournals(body) {
              const rep = [];
              let doc,
                  title,
                  halId,
                  alreadySaved;

              for (let i = 0; i < body.length; i++) {
                  doc = body[i];
                  title = doc.journalTitle_s;
                  halId = doc.halId_s;

                  if (alreadySaved = rep.find(journal => journal.title === title)) {
                      alreadySaved.publications.push(halId);
                  } else {
                      rep.push({title: title, publications: [halId]});
                  }
              }

              return rep;
          }

          _stringify(item) {
              return JSON.stringify(item);
          }
      }

      window.customElements.define(JournalsCarto.is, JournalsCarto);
  </script>
</dom-module>