<dom-module id="journals-carto">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
        padding: 2px;
      }

      #query {
        @apply(--layout-flex-none);
      }

      #chart {
        @apply(--layout-flex);
        font-family: "sans-serif";
        font-size: 10px;
        text-anchor: "middle";
      }

      #title {
        @apply(--layout-flex);
        max-height: 20px;
        font-family: 'Roboto', sans-serif;
        color: #9e9e9e;
        font-size: 15px;
      }
    </style>

    <query-manager
        id="query"
        query=[[authorName]]
        params='{"fl":"journalTitle_s,halId_s,title_s"}'
        on-response=_loadVisu>
    </query-manager>

    <svg id="chart"></svg>
    <app-toolbar id="title"><div main-title>Where he published</div></app-toolbar>

  </template>

  <script>
      /**
       * @customElement
       * @polymer
       */
      class JournalsCarto extends Polymer.Element {
          static get is() {
              return 'journals-carto';
          }

          static get properties() {
              return {
                  /**
                   * Currently selected author whose cartography has to be displayed
                   */
                  authorName: {
                      type: String,
                      observer: '_fetchJournals',
                      value: null
                  },

                  /**
                   * List of the journals in which this author has published
                   */
                  _journals: {
                      type: Array,
                      value: () => []
                  }
              };
          }

          _fetchJournals(newVal) {
              if (newVal) {
                  this.$.query.fetchAsJSON();
              }
          }

          _loadVisu(e) {
              this.set('_journals', JournalsCarto._loadJournals(e.detail.body));

              const svg = d3.select(this.$.chart);
              svg.html('');
              const height = +svg._groups[0][0].clientHeight;
              const width = +svg._groups[0][0].clientWidth;

              const color = d3.scaleOrdinal(d3.schemeCategory20c);

              const bubble = d3.pack()
                  .size([width, height])
                  .padding(1.5);

              const data = this._journals.map(d => { d.value = +d.publications.length; return d; });

              const root = d3.hierarchy({children: data})
                  .sum(d => d.value)
                  .each(d => d.title = d.data.title || 'No Journal Title Found');

              const bubbles = svg.selectAll('.node')
                  .data(bubble(root).leaves())
                  .enter().append('g')
                  .attr('class', 'node')
                  .attr('transform', d => 'translate(' + d.x + ',' + d.y + ')');

              bubbles.append('circle')
                  .attr('r', d => d.r)
                  .style('fill', d => color(d.title));

              bubbles.append('clipPath')
                  .attr('id', d => 'clip-' + d.title)
                  .append('use')
                  .attr('xlink:href', d => '#' + d.title);

              bubbles.append('text')
                  .attr('clip-path', d => 'url(#clip-' + d.title + ')')
                  .attr('text-anchor', 'middle')
                  .selectAll('tspan')
                  .data(d => JournalsCarto._shortenTitle(d.title))
                  .enter().append('tspan')
                  .attr('x', 0)
                  .attr('y', (d, i, nodes) => 13 + (i - nodes.length / 2 - 0.5) * 10)
                  .text(d => d);

              bubbles.append('title')
                  .text(d => d.title + ':\n\n- ' + d.data.publications.map(pub => pub.title).join('\n- '));
          }

          static _loadJournals(body) {
              const rep = [];
              let journalTitle,
                  publication,
                  alreadySaved;

              body.forEach(doc => {
                  journalTitle = doc.journalTitle_s;
                  publication = {halId: doc.halId_s, title: doc.title_s[0]};

                  if (alreadySaved = rep.find(journal => journal.title === journalTitle)) {
                      alreadySaved.publications.push(publication);
                  } else {
                      rep.push({title: journalTitle, publications: [publication]});
                  }
              });

              return rep;
          }

          static _shortenTitle(title) {
              let split = title.split(' ');
              if (split.length > 4) {
                  split = split.slice(0, 4);
                  split[3] += '...'
              }
              return split;
          }
      }

      window.customElements.define(JournalsCarto.is, JournalsCarto);
  </script>
</dom-module>